# -*- coding: utf-8 -*-
"""Trajectory_2500_lungs.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12km0m-qpQc9m9zemHaFVSDljdJgTyyGD
"""

!pip install scanpy
!pip install anndata
!pip3 install igraph
!pip install celltypist
!pip install decoupler
!pip install fa2-modified
!pip install louvain
!pip install scvelo

#Import core single cell datasets
import scanpy as sc
import anndata as ad
import numpy as np
import matplotlib.pyplot as plt

!mkdir -p GSM5082289_Mock
!mkdir -p GSM5082290_1dpi
!mkdir -p GSM5082291_2dpi
!mkdir -p GSM5082292_3dpi

!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082289/suppl/GSM5082289_mock_barcodes.tsv.gz -O GSM5082289_Mock/barcodes.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082289/suppl/GSM5082289_mock_features.tsv.gz -O GSM5082289_Mock/features.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082289/suppl/GSM5082289_mock_matrix.mtx.gz -O GSM5082289_Mock/matrix.mtx.gz

!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082290/suppl/GSM5082290_1dpi_barcodes.tsv.gz -O GSM5082290_1dpi/barcodes.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082290/suppl/GSM5082290_1dpi_features.tsv.gz -O GSM5082290_1dpi/features.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082290/suppl/GSM5082290_1dpi_matrix.mtx.gz -O GSM5082290_1dpi/matrix.mtx.gz

!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082291/suppl/GSM5082291_2dpi_barcodes.tsv.gz -O GSM5082291_2dpi/barcodes.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082291/suppl/GSM5082291_2dpi_features.tsv.gz -O GSM5082291_2dpi/features.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082291/suppl/GSM5082291_2dpi_matrix.mtx.gz -O GSM5082291_2dpi/matrix.mtx.gz

!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082292/suppl/GSM5082292_3dpi_barcodes.tsv.gz -O GSM5082292_3dpi/barcodes.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082292/suppl/GSM5082292_3dpi_features.tsv.gz -O GSM5082292_3dpi/features.tsv.gz
!wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5082nnn/GSM5082292/suppl/GSM5082292_3dpi_matrix.mtx.gz -O GSM5082292_3dpi/matrix.mtx.gz

import scanpy as sc

mock_adata = sc.read_10x_mtx('/content/GSM5082289_Mock/')
dpi1_adata = sc.read_10x_mtx('/content/GSM5082290_1dpi/')
dpi2_adata = sc.read_10x_mtx('/content/GSM5082291_2dpi/')
dpi3_adata = sc.read_10x_mtx('/content/GSM5082292_3dpi/')

# QUALITY CONTROL

# Creating lists of MT, RIBO and HB genes for Mock sample.
mock_adata.var['MT'] = mock_adata.var_names.str.startswith("MT-")
mock_adata.var['RIBO'] = mock_adata.var_names.str.startswith(("RPS", "RPL"))
mock_adata.var['HB'] = mock_adata.var_names.str.contains(r"^HB[^P]")

# Creating lists of MT, RIBO and HB genes for Day_1 sample.
dpi1_adata.var['MT'] = dpi1_adata.var_names.str.startswith("MT-")
dpi1_adata.var['RIBO'] = dpi1_adata.var_names.str.startswith(("RPS", "RPL"))
dpi1_adata.var['HB'] = dpi1_adata.var_names.str.contains(r"^HB[^P]")

# Creating lists of MT, RIBO and HB genes for Day_2 sample.
dpi2_adata.var['MT'] = dpi2_adata.var_names.str.startswith("MT-")
dpi2_adata.var['RIBO'] = dpi2_adata.var_names.str.startswith(("RPS", "RPL"))
dpi2_adata.var['HB'] = dpi2_adata.var_names.str.contains(r"^HB[^P]")

# Creating lists of MT, RIBO and HB genes for Day_3 sample.
dpi3_adata.var['MT'] = dpi3_adata.var_names.str.startswith("MT-")
dpi3_adata.var['RIBO'] = dpi3_adata.var_names.str.startswith(("RPS", "RPL"))
dpi3_adata.var['HB'] = dpi3_adata.var_names.str.contains(r"^HB[^P]")

# Creating QC metrics with MT, RIBO and HB genes for Mock sample.
sc.pp.calculate_qc_metrics(
    mock_adata, qc_vars=["MT", 'RIBO', 'HB'], inplace=True, log1p=True
)

# Creating QC metrics with MT, RIBO and HB genes for Day_1 sample.
sc.pp.calculate_qc_metrics(
    dpi1_adata, qc_vars=["MT", 'RIBO', 'HB'], inplace=True, log1p=True
)

# Creating QC metrics with MT, RIBO and HB genes for Day_2 sample.
sc.pp.calculate_qc_metrics(
    dpi2_adata, qc_vars=["MT", 'RIBO', 'HB'], inplace=True, log1p=True
)

# Creating QC metrics with MT, RIBO and HB genes for Dat_3 sample.
sc.pp.calculate_qc_metrics(
    dpi3_adata, qc_vars=["MT", 'RIBO', 'HB'], inplace=True, log1p=True
)

sc.pp.filter_cells(mock_adata, min_genes=200)
sc.pp.filter_genes(mock_adata, min_cells=3)
mock_adata = mock_adata[mock_adata.obs['pct_counts_MT'] < 10, :]

sc.pp.filter_cells(dpi1_adata, min_genes=200)
sc.pp.filter_genes(dpi1_adata, min_cells=3)
dpi1_adata = dpi1_adata[dpi1_adata.obs['pct_counts_MT'] < 10, :]

sc.pp.filter_cells(dpi2_adata, min_genes=200)
sc.pp.filter_genes(dpi2_adata, min_cells=3)
dpi2_adata = dpi2_adata[dpi2_adata.obs['pct_counts_MT'] < 10, :]

sc.pp.filter_cells(dpi3_adata, min_genes=200)
sc.pp.filter_genes(dpi3_adata, min_cells=3)
dpi3_adata = dpi3_adata[dpi3_adata.obs['pct_counts_MT'] < 10, :]

sc.pp.scrublet(mock_adata)
sc.pp.scrublet(dpi1_adata)
sc.pp.scrublet(dpi2_adata)
sc.pp.scrublet(dpi3_adata)

mock_adata = mock_adata[~mock_adata.obs['predicted_doublet'], :]
dpi1_adata = dpi1_adata[~dpi1_adata.obs['predicted_doublet'], :]
dpi2_adata = dpi2_adata[~dpi2_adata.obs['predicted_doublet'], :]
dpi3_adata = dpi3_adata[~dpi3_adata.obs['predicted_doublet'], :]

# NORMALIZATION

# Mock
# Copy the data for safety
mock_adata.layers["counts"] = mock_adata.X.copy()
# Standartize expression
sc.pp.normalize_total(mock_adata)
sc.pp.log1p(mock_adata)

# Day_1
# Copy the data for safety
dpi1_adata.layers["counts"] = dpi1_adata.X.copy()
# Standartize expression
sc.pp.normalize_total(dpi1_adata)
sc.pp.log1p(dpi1_adata)

# Day_2
# Copy the data for safety
dpi2_adata.layers["counts"] = dpi2_adata.X.copy()
# Standartize expression
sc.pp.normalize_total(dpi2_adata)
sc.pp.log1p(dpi2_adata)

# Day_3
# Copy the data for safety
dpi3_adata.layers["counts"] = dpi3_adata.X.copy()
# Standartize expression
sc.pp.normalize_total(dpi3_adata)
sc.pp.log1p(dpi3_adata)

#Feature selection (2500 genes)

# Mock
sc.pp.highly_variable_genes(mock_adata, n_top_genes=2500)
sc.pl.highly_variable_genes(mock_adata)

# Day_1
sc.pp.highly_variable_genes(dpi1_adata, n_top_genes=2500)
sc.pl.highly_variable_genes(dpi1_adata)

# Day_2
sc.pp.highly_variable_genes(dpi2_adata, n_top_genes=2500)
sc.pl.highly_variable_genes(dpi2_adata)

# Day_3
sc.pp.highly_variable_genes(dpi3_adata, n_top_genes=2500)
sc.pl.highly_variable_genes(dpi3_adata)

# DIMENSIONALITY REDUCTION

# Mock
sc.tl.pca(mock_adata)
sc.pl.pca_variance_ratio(mock_adata, n_pcs=10, log=False)

# Day_1
sc.tl.pca(dpi1_adata)
sc.pl.pca_variance_ratio(dpi1_adata, n_pcs=10, log=False)

# Day_2
sc.tl.pca(dpi2_adata)
sc.pl.pca_variance_ratio(dpi2_adata, n_pcs=10, log=False)

# Day_3
sc.tl.pca(dpi3_adata)
sc.pl.pca_variance_ratio(dpi3_adata, n_pcs=10, log=False)

# Create a figure with subplots
fig, axes = plt.subplots(2, 2, figsize=(10, 8))
# Overview of the total number of genes in cells after PCA
# Mock
sc.pl.pca(mock_adata, color = ['n_genes_by_counts'], cmap="coolwarm", title="mock", ax=axes[0,0], show=False)
# Day_1
sc.pl.pca(dpi1_adata, color = ['n_genes_by_counts'], cmap="coolwarm", title="dpi1", ax=axes[0,1], show=False)
# Day_2
sc.pl.pca(dpi2_adata,color = ['n_genes_by_counts'], cmap="coolwarm", title="dpi2", ax=axes[1,0], show=False)
# Day_3
sc.pl.pca(dpi3_adata, color = ['n_genes_by_counts'], cmap="coolwarm", title="dpi3", ax=axes[1,1], show=False)
plt.tight_layout()
plt.show()

# UMAP

# Calculate the nearest neighbors
# Mock
sc.pp.neighbors(mock_adata)
sc.tl.umap(mock_adata)

# Day_1
sc.pp.neighbors(dpi1_adata)
sc.tl.umap(dpi1_adata)

# Day_2
sc.pp.neighbors(dpi2_adata)
sc.tl.umap(dpi2_adata)

# Day_3
sc.pp.neighbors(dpi3_adata)
sc.tl.umap(dpi3_adata)

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(10, 8))

# Overview of the total number of genes in cells after UMAP
# Mock
sc.pl.umap(mock_adata, color = ['n_genes_by_counts'], cmap='coolwarm', vmax='p95', size=8, title="mock", ax=axes[0,0], show=False)
# Day_1
sc.pl.umap(dpi1_adata, color = ['n_genes_by_counts'], cmap='coolwarm', vmax='p95', size=8, title="dpi1",  ax=axes[0,1], show=False)
# Day_2
sc.pl.umap(dpi2_adata,color = ['n_genes_by_counts'], cmap='coolwarm', vmax='p95', size=8, title="dpi2", ax=axes[1,0], show=False)
# Day_3
sc.pl.umap(dpi3_adata, color = ['n_genes_by_counts'], cmap='coolwarm', vmax='p95', size=8, title="dpi3", ax=axes[1,1], show=False)

plt.tight_layout()
plt.show()

# Leiden clustering
# Mock
sc.tl.leiden(mock_adata, flavor="igraph", n_iterations=2, key_added="leiden_res0_5", resolution=0.5)
#Day_1
sc.tl.leiden(dpi1_adata, flavor="igraph", n_iterations=2, key_added="leiden_res0_5", resolution=0.5)
# Day_2
sc.tl.leiden(dpi2_adata, flavor="igraph", n_iterations=2, key_added="leiden_res0_5", resolution=0.5)
# Day_3
sc.tl.leiden(dpi3_adata, flavor="igraph", n_iterations=2, key_added="leiden_res0_5", resolution=0.5)

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(10, 8))

# Leiden clustering visualization.
# Mock
sc.pl.umap(mock_adata, color=["leiden_res0_5"], vmax='p95', size=8, title="Mock", ax=axes[0,0], show=False)
# Day_1
sc.pl.umap(dpi1_adata, color=["leiden_res0_5"], vmax='p95', size=8, title="Day_1", ax=axes[0,1], show=False)
# Day_2
sc.pl.umap(dpi2_adata, color=["leiden_res0_5"], vmax='p95', size=8, title="Day_2", ax=axes[1,0], show=False)
# Day_3
sc.pl.umap(dpi3_adata, color=["leiden_res0_5"], vmax='p95', size=8, title="Day_3", ax=axes[1,1], show=False)

plt.tight_layout()
plt.show()

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(10, 8))

# Leiden clustering visualization.
# Mock
sc.pl.umap(mock_adata, color=["leiden_res0_5"], vmax='p95', size=8, legend_loc="on data", title="Mock", ax=axes[0,0], show=False)
# Day_1
sc.pl.umap(dpi1_adata, color=["leiden_res0_5"], vmax='p95', size=8, legend_loc="on data", title="Day_1", ax=axes[0,1], show=False)
# Day_2
sc.pl.umap(dpi2_adata, color=["leiden_res0_5"], vmax='p95', size=8, legend_loc="on data", title="Day_2", ax=axes[1,0], show=False)
# Day_3
sc.pl.umap(dpi3_adata, color=["leiden_res0_5"], vmax='p95', size=8, legend_loc="on data", title="Day_3", ax=axes[1,1], show=False)

plt.tight_layout()
plt.show()

# CELL ANNOTATION

import decoupler as dc

# Query Omnipath and get PanglaoDB
markers = dc.op.resource(name="PanglaoDB", organism="human")

# Keep canonical cell type markers alone
markers = markers[markers["organ"] == 'Lungs']

# Remove duplicated entries
markers = markers[~markers.duplicated(["cell_type", "genesymbol"])]

# Format because dc only accepts cell_type and genesymbol

markers = markers.rename(columns={"cell_type": "source", "genesymbol": "target"})
markers = markers[["source", "target"]]

markers.head()

# Cell type annotation using ULM (Univariate Linear Model)
# Estimates cell type scores based on marker gene expression
dc.mt.ulm(data=mock_adata, net=markers, tmin = 2)
dc.mt.ulm(data=dpi1_adata, net=markers, tmin = 2)
dc.mt.ulm(data=dpi2_adata, net=markers, tmin = 2)
dc.mt.ulm(data=dpi3_adata, net=markers, tmin = 2)

# Extract ULM cell type scores stored in obsm layer
score_mock = dc.pp.get_obsm(mock_adata, key="score_ulm")
score_dpi1 = dc.pp.get_obsm(dpi1_adata, key="score_ulm")
score_dpi2 = dc.pp.get_obsm(dpi2_adata, key="score_ulm")
score_dpi3 = dc.pp.get_obsm(dpi3_adata, key="score_ulm")

# Rank genes Mock
mock_adata_gene_rank = dc.tl.rankby_group(score_mock, groupby="leiden_res0_5", reference="rest", method="t-test_overestim_var")
mock_adata_gene_rank = mock_adata_gene_rank[mock_adata_gene_rank["stat"] > 0]
mock_adata_gene_rank.head(5)

# Rank genes Day_1
dpi1_adata_gene_rank = dc.tl.rankby_group(score_dpi1, groupby="leiden_res0_5", reference="rest", method="t-test_overestim_var")
dpi1_adata_gene_rank = dpi1_adata_gene_rank[dpi1_adata_gene_rank["stat"] > 0]
dpi1_adata_gene_rank.head(5)

# Rank genes Day_2
dpi2_adata_gene_rank = dc.tl.rankby_group(score_dpi2, groupby="leiden_res0_5", reference="rest", method="t-test_overestim_var")
dpi2_adata_gene_rank = dpi2_adata_gene_rank[dpi2_adata_gene_rank["stat"] > 0]
dpi2_adata_gene_rank.head(5)

# Rank genes Day_3
dpi3_adata_gene_rank = dc.tl.rankby_group(score_dpi3, groupby="leiden_res0_5", reference="rest", method="t-test_overestim_var")
dpi3_adata_gene_rank = dpi3_adata_gene_rank[dpi3_adata_gene_rank["stat"] > 0]
dpi3_adata_gene_rank.head(5)

# Extract the top-scoring cell type for each cluster Mock
top_cell_type_per_group_mock = mock_adata_gene_rank.groupby('group')['name'].apply(lambda x: x.head(1))
display(top_cell_type_per_group_mock.to_dict())

# Extract the top-scoring cell type for each cluster Day_1
top_cell_type_per_group_dpi1 = dpi1_adata_gene_rank.groupby('group')['name'].apply(lambda x: x.head(1))
display(top_cell_type_per_group_dpi1.to_dict())

# Extract the top-scoring cell type for each cluster Day_2
top_cell_type_per_group_dpi2 = dpi2_adata_gene_rank.groupby('group')['name'].apply(lambda x: x.head(1))
display(top_cell_type_per_group_dpi2.to_dict())

# Extract the top-scoring cell type for each cluster Day_3
top_cell_type_per_group_dpi3 = dpi3_adata_gene_rank.groupby('group')['name'].apply(lambda x: x.head(1))
display(top_cell_type_per_group_dpi3.to_dict())

# Map each cluster to its top cell type annotation (filtering positive scores) - Mock
dict_ann_mock = (mock_adata_gene_rank[(mock_adata_gene_rank["stat"] > 0)].groupby("group").head(1).set_index("group")["name"].to_dict())
dict_ann_mock

# Map each cluster to its top cell type annotation (filtering positive scores) - Day_1
dict_ann_dpi1 = (dpi1_adata_gene_rank[(dpi1_adata_gene_rank["stat"] > 0)].groupby("group").head(1).set_index("group")["name"].to_dict())
dict_ann_dpi1

# Map each cluster to its top cell type annotation (filtering positive scores) - Day_2
dict_ann_dpi2 = (dpi2_adata_gene_rank[(dpi2_adata_gene_rank["stat"] > 0)].groupby("group").head(1).set_index("group")["name"].to_dict())
dict_ann_dpi2

# Map each cluster to its top cell type annotation (filtering positive scores) - Day_3
dict_ann_dpi3 = (dpi3_adata_gene_rank[(dpi3_adata_gene_rank["stat"] > 0)].groupby("group").head(1).set_index("group")["name"].to_dict())
dict_ann_dpi3

# ANNOTATED CELL CLUSTERS PLOT - MOCK - 3A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# Annotate clusters with cell type labels using the annotation dictionary
mock_adata.obs["cell_type"] = mock_adata.obs["leiden_res0_5"].map(dict_ann_mock).astype('category')
# Visualization (legend out and on clusters)
sc.pl.umap(mock_adata, color='cell_type', ax=axes[0], show=False)
sc.pl.umap(mock_adata, color='cell_type', legend_loc='on data', legend_fontsize=7, ax=axes[1], show=False)
# Adjust title
plt.suptitle("Annotated Cell Clusters - Mock", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# Verify
print("\nMock cell types:")
print(mock_adata.obs['cell_type'].value_counts())

# ANNOTATED CELL CLUSTERS PLOT - DAY_1 - 3A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# Annotate clusters with cell type labels using the annotation dictionary
dpi1_adata.obs["cell_type"] = dpi1_adata.obs["leiden_res0_5"].map(dict_ann_dpi1)
# Visualization (legend out and on clusters)
sc.pl.umap(dpi1_adata, color='cell_type', ax=axes[0], show=False)
sc.pl.umap(dpi1_adata, color='cell_type', legend_loc='on data', legend_fontsize=7, ax=axes[1], show=False)
# Adjust title
plt.suptitle("Annotated Cell Clusters - Day 1", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# Verify
print("\nDay 1 cell types:")
print(dpi1_adata.obs['cell_type'].value_counts())

# ANNOTATED CELL CLUSTERS PLOT - DAY_2 - 3A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# Annotate clusters with cell type labels using the annotation dictionary
dpi2_adata.obs["cell_type"] = dpi2_adata.obs["leiden_res0_5"].map(dict_ann_dpi2)
# Fill any unassigned cell types with 'Unassigned'
#dpi2_adata.obs["cell_type"] = dpi2_adata.obs["leiden_res0_5"].fillna("Unassigned").astype('category')
# Visualization (legend out and on clusters)
sc.pl.umap(dpi2_adata, color='cell_type', ax=axes[0], show=False)
sc.pl.umap(dpi2_adata, color='cell_type', legend_loc='on data', legend_fontsize=7, ax=axes[1], show=False)
# Adjust title
plt.suptitle("Annotated Cell Clusters - Day 2 (NA)", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# ANNOTATED CELL CLUSTERS PLOT - DAY_3 - 3A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# Annotate clusters with cell type labels using the annotation dictionary
dpi3_adata.obs["cell_type"] = dpi3_adata.obs["leiden_res0_5"].map(dict_ann_dpi3)
# Visualization (legend out and on clusters)
sc.pl.umap(dpi3_adata, color='cell_type', ax=axes[0], show=False)
sc.pl.umap(dpi3_adata, color='cell_type', legend_loc='on data', legend_fontsize=7, ax=axes[1], show=False)
# Adjust title
plt.suptitle("Annotated Cell Clusters - Day 3 (NA)", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# Which cluster is NA? DPI2
na_cluster_dpi2 = dpi2_adata.obs[dpi2_adata.obs['cell_type'].isna()]['leiden_res0_5'].value_counts()
print("NA clusters:", na_cluster_dpi2)
# Cluster number
na_cluster_number_dpi2 = '2'

# Find marker genes for NA cluster - DPI2
sc.tl.rank_genes_groups(dpi2_adata, groupby='leiden_res0_5', method='wilcoxon')
# Look at top 15 genes
result = dpi2_adata.uns['rank_genes_groups']
print(f"Top genes for cluster {na_cluster_number_dpi2}:")
for i in range(15):
    gene = result['names'][na_cluster_number_dpi2][i]
    print(f"{i+1}. {gene}")

# Assign cluster 2 as Basal cells - DPI2
# Get current categories and add 'Basal cells'
current_categories = dpi2_adata.obs['leiden_res0_5'].cat.categories.tolist()
if 'Basal cells' not in current_categories:
    new_categories = current_categories + ['Basal cells']
    dpi2_adata.obs['leiden_res0_5'] = dpi2_adata.obs['leiden_res0_5'].cat.set_categories(new_categories)

# Add 'Basal cells' to the 'cell_type' categories
current_cell_type_categories = dpi2_adata.obs['cell_type'].cat.categories.tolist()
if 'Basal cells' not in current_cell_type_categories:
    new_cell_type_categories = current_cell_type_categories + ['Basal cells']
    dpi2_adata.obs['cell_type'] = dpi2_adata.obs['cell_type'].cat.set_categories(new_cell_type_categories)

dpi2_adata.obs.loc[dpi2_adata.obs['leiden_res0_5'] == '2', 'cell_type'] = 'Basal cells'

# Verify no more NAs
print("Remaining NAs in 2dpi:", dpi2_adata.obs['cell_type'].isna().sum())
print("\n2dpi cell types now:")
print(dpi2_adata.obs['cell_type'].value_counts())

# Fix cluster 2 (was NA/Unknown, should be Basal cells)
dict_ann_dpi2['2'] = 'Basal cells'
# Check the dictionary
print("Updated dictionary:")
print(dict_ann_dpi2)
# Now apply it
dpi2_adata.obs["cell_type"] = dpi2_adata.obs["leiden_res0_5"].map(dict_ann_dpi2)
# Verify
print("\nDay 2 NAs:", dpi2_adata.obs['cell_type'].isna().sum())
print("\nDay 2 cell types:")
print(dpi2_adata.obs['cell_type'].value_counts())

# ANNOTATED CELL CLUSTERS PLOT - DAY_2 - 3A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# Annotate clusters with cell type labels using the annotation dictionary
dpi2_adata.obs["cell_type"] = dpi2_adata.obs["leiden_res0_5"].map(dict_ann_dpi2)
# Visualization (legend out and on clusters)
sc.pl.umap(dpi2_adata, color='cell_type', ax=axes[0], show=False)
sc.pl.umap(dpi2_adata, color='cell_type', legend_loc='on data', legend_fontsize=7, ax=axes[1], show=False)
# Adjust title
plt.suptitle("Annotated Cell Clusters - Day 2", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# Which cluster is NA? - DPI3
na_cluster_dpi3 = dpi3_adata.obs[dpi3_adata.obs['cell_type'].isna()]['leiden_res0_5'].value_counts()
print("NA clusters:", na_cluster_dpi3)
# Cluster number
na_cluster_number_dpi3_1 = '8'
na_cluster_number_dpi3_2 = '7'

# Find marker genes for NA cluster - DPI3, cluster 8
# The actual cell type was assigned to the 'cell_type' column, not 'leiden_res0_5'.
# Cluster 8 was assigned 'Proliferating basal cells' in a previous step.
sc.tl.rank_genes_groups(dpi3_adata, groupby='leiden_res0_5', method='wilcoxon')
# Look at top 15 genes for 'Proliferating basal cells'
result = dpi3_adata.uns['rank_genes_groups']
print(f"Top genes for cluster {na_cluster_number_dpi3_1}:")
for i in range(15):
    gene = result['names'][na_cluster_number_dpi3_1][i]
    print(f"{i+1}. {gene}")

# Find marker genes for NA cluster - DPI3, cluster 7
sc.tl.rank_genes_groups(dpi3_adata, groupby='leiden_res0_5', method='wilcoxon')
# Look at top 15 genes
result = dpi3_adata.uns['rank_genes_groups']
print(f"Top genes for cluster {na_cluster_number_dpi3_2}:")
for i in range(15):
    gene = result['names'][na_cluster_number_dpi3_2][i]
    print(f"{i+1}. {gene}")

# Assign cluster 7 as Basal cells & cluster 8 as Germ cells (? - proliferating epithelium cells)
# Add 'Basal cells' to leiden_res0_5 categories
current_leiden_categories = dpi3_adata.obs['leiden_res0_5'].cat.categories.tolist()
if 'Basal cells' not in current_leiden_categories:
    new_leiden_categories = current_leiden_categories + ['Basal cells']
    dpi3_adata.obs['leiden_res0_5'] = dpi3_adata.obs['leiden_res0_5'].cat.set_categories(new_leiden_categories)
# Add 'Basal cells' to cell_type categories
current_cell_type_categories = dpi3_adata.obs['cell_type'].cat.categories.tolist()
if 'Basal cells' not in current_cell_type_categories:
    new_cell_type_categories = current_cell_type_categories + ['Basal cells']
    dpi3_adata.obs['cell_type'] = dpi3_adata.obs['cell_type'].cat.set_categories(new_cell_type_categories)

dpi3_adata.obs.loc[dpi3_adata.obs['leiden_res0_5'] == '7', 'cell_type'] = 'Basal cells'

# Add 'Proliferating basal cells' to leiden_res0_5 categories
current_leiden_categories = dpi3_adata.obs['leiden_res0_5'].cat.categories.tolist()
if 'Proliferating basal cells' not in current_leiden_categories:
    new_leiden_categories = current_leiden_categories + ['Proliferating basal cells']
    dpi3_adata.obs['leiden_res0_5'] = dpi3_adata.obs['leiden_res0_5'].cat.set_categories(new_leiden_categories)
# Add 'Proliferating epithelium cells' to cell_type categories
current_cell_type_categories = dpi3_adata.obs['cell_type'].cat.categories.tolist()
if 'Proliferating basal cells' not in current_cell_type_categories:
    new_cell_type_categories = current_cell_type_categories + ['Proliferating basal cells']
    dpi3_adata.obs['cell_type'] = dpi3_adata.obs['cell_type'].cat.set_categories(new_cell_type_categories)

dpi3_adata.obs.loc[dpi3_adata.obs['leiden_res0_5'] == '8', 'cell_type'] = 'Proliferating basal cells'

# Verify no more NAs
print("Remaining NAs in 3dpi:", dpi3_adata.obs['cell_type'].isna().sum())
print("\n3dpi cell types now:")
print(dpi3_adata.obs['cell_type'].value_counts())

# Assuming you already have dict_ann_dpi3
dict_ann_dpi3['7'] = 'Basal cells'
dict_ann_dpi3['8'] = 'Proliferating basal cells'
# Apply
dpi3_adata.obs["cell_type"] = dpi3_adata.obs["leiden_res0_5"].map(dict_ann_dpi3)
# Verify
print("\nDay 3 NAs:", dpi3_adata.obs['cell_type'].isna().sum())
print("\nDay 3 cell types:")
print(dpi3_adata.obs['cell_type'].value_counts())

# ANNOTATED CELL CLUSTERS PLOT - DAY_3 - 3A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# Annotate clusters with cell type labels using the annotation dictionary
#dpi3_adata.obs["cell_type"] = dpi3_adata.obs["leiden_res0_5"].map(dict_ann_dpi3)
# Visualization (legend out and on clusters)
sc.pl.umap(dpi3_adata, color='cell_type', ax=axes[0], show=False)
sc.pl.umap(dpi3_adata, color='cell_type', legend_loc='on data', legend_fontsize=7, ax=axes[1], show=False)
# Adjust title
plt.suptitle("Annotated Cell Clusters - Day 3", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()


# MOCK CELL TYPE GENES - 3B PLOT (STACK VIOLIN)
# Find top expressed genes per cell type
sc.tl.rank_genes_groups(mock_adata, groupby='cell_type', method='wilcoxon')
# Look at top genes
sc.pl.rank_genes_groups(mock_adata, n_genes=10, sharey=False)
# Print them
for cell_type in mock_adata.obs['cell_type'].unique():
    print(f"\n{cell_type}:")
    print(mock_adata.uns['rank_genes_groups']['names'][cell_type][:5])

# MOCK CELL TYPE GENES DICTIONNARY
marker_genes_dict_mock = {
    "Ciliated cells": ['CAPS', 'C1orf194', 'PIFO', 'C20orf85', 'CETN2'],
    "Alveolar macrophages": ['S100A2', 'KRT15', 'RPLP1', 'KRT14', 'GAPDH'],
    "Ionocytes": ['SERPINB3', 'MT-CO2', 'MT-ND3', 'KRT19', 'MT-CYB'],
    "Airway goblet cells": ['WFDC2', 'S100P', 'TMSB4X', 'SLPI', 'SCGB3A1'],
    "Pulmonary alveolar type II cells": ['KRT16', 'SPRR1B', 'KRT6A', 'CSTA', 'KRT13'],
    "Pulmonary alveolar type I cells": ['KRT14', 'IGFBP6', 'COL17A1', 'KRT15', 'LAMB3']
}

# MOCK STACKED VIOLIN PLOT
import numpy as np
sc.pl.stacked_violin(mock_adata, marker_genes_dict_mock, cmap='RdBu_r', groupby="cell_type", show=False)
# Adjust title
plt.suptitle("Marker Gene Expression - Mock", y=1.5, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# DPI1 CELL TYPE GENES - 3B PLOT (STACK VIOLIN)
# DPI1 CELL TYPE GENES
# Find top expressed genes per cell type
sc.tl.rank_genes_groups(dpi1_adata, groupby='cell_type', method='wilcoxon')
# Look at top genes
sc.pl.rank_genes_groups(dpi1_adata, n_genes=10, sharey=False)
# Print them
for cell_type in dpi1_adata.obs['cell_type'].unique():
    print(f"\n{cell_type}:")
    print(dpi1_adata.uns['rank_genes_groups']['names'][cell_type][:5])

# DPI1 CELL TYPE GENES DICTIONNARY
marker_genes_dict_dpi1 = {
    "Ciliated cells": ['C9orf24', 'C20orf85', 'CAPS', 'PIFO', 'TUBA1A'],
    "Pulmonary alveolar type I cells": ['RPS18', 'RPS12', 'RPS3', 'RPL13', 'S100A14'],
    "Ionocytes": ['SCGB1A1', 'TMSB4X', 'SCGB3A1', 'EIF1', 'TMSB10'],
    "Airway goblet cells": ['WFDC2', 'LCN2', 'SLPI', 'CEACAM6', 'LYPD2'],
    "Airway epithelial cells": ['ASCL1', 'AZGP1', 'TFF3', 'CPE', 'IGFBP5'],
    "Alveolar macrophages": ['scv2_orf1-10', 'TNFAIP3', 'NFKBIA', 'PER1', 'PMAIP1']
}

# DPI1 STACKED VIOLIN PLOT
import numpy as np
sc.pl.stacked_violin(dpi1_adata, marker_genes_dict_dpi1, cmap='RdBu_r', groupby="cell_type", show=False)
# Adjust title
plt.suptitle("Marker Gene Expression - Day 1", y=1.5, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# DPI2 CELL TYPE GENES - 3B PLOT (STACK VIOLIN)
# DPI2 CELL TYPE GENES
# Find top expressed genes per cell type
sc.tl.rank_genes_groups(dpi2_adata, groupby='cell_type', method='wilcoxon')
# Look at top genes
sc.pl.rank_genes_groups(dpi2_adata, n_genes=10, sharey=False)
# Print them
for cell_type in dpi2_adata.obs['cell_type'].unique():
    print(f"\n{cell_type}:")
    print(dpi2_adata.uns['rank_genes_groups']['names'][cell_type][:5])

# DPI2 CELL TYPE GENES DICTIONNARY
marker_genes_dict_dpi2 = {
    "Airway goblet cells": ['WFDC2', 'LCN2', 'SLPI', 'C3', 'CEACAM6'],
    "Basal cells": ['KRT14', 'KRT15', 'KRT5', 'IGFBP6', 'S100A2'],
    "Ciliated cells": ['CAPS', 'TUBB4B', 'C9orf24', 'C20orf85', 'DYNLL1'],
    "Ionocytes": ['SCGB1A1', 'TXNIP', 'FAM3D', 'S100A6', 'SCGB3A1'],
    "Pulmonary alveolar type I cells": ['KRT13', 'AQP3', 'HSPB1', 'S100A2', 'SPINK5'],
    "Alveolar macrophages": ['scv2_orf1-10', 'IFI6', 'NFKBIA', 'QPCT', 'HLA-B'],
    "Airway epithelial cells": ['SERPINB3', 'CSTA', 'RPS18', 'S100A2', 'RPL36'],
    "Clara cells": ['LRRC75A', 'CEACAM5', 'ZFP36L1', 'CEACAM6', 'C15orf48']
}

# DPI2 STACKED VIOLIN PLOT
import numpy as np
sc.pl.stacked_violin(dpi2_adata, marker_genes_dict_dpi2, cmap='RdBu_r', groupby="cell_type", show=False)
# Adjust title
plt.suptitle("Marker Gene Expression - Day 2", y=1.5, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# DPI3 CELL TYPE GENES
# Find top expressed genes per cell type
sc.tl.rank_genes_groups(dpi3_adata, groupby='cell_type', method='wilcoxon')
# Look at top genes
sc.pl.rank_genes_groups(dpi3_adata, n_genes=10, sharey=False)
# Print them
for cell_type in dpi3_adata.obs['cell_type'].unique():
    print(f"\n{cell_type}:")
    print(dpi3_adata.uns['rank_genes_groups']['names'][cell_type][:5])

# DPI3 CELL TYPE GENES DICTIONNARY
marker_genes_dict_dpi3 = {
    "Ciliated cells": ['CAPS', 'TUBA1A', 'C9orf24', 'C20orf85', 'RSPH1'],
    "Alveolar macrophages": ['scv2_orf1-10', 'NFKBIA', 'SQSTM1', 'JUN', 'RAB3IP'],
    "Airway goblet cells": ['WFDC2', 'LCN2', 'SLPI', 'CEACAM6', 'CXCL17'],
    "Basal cells": ['KRT15', 'DST', 'KRT5', 'KRT14', 'IGFBP6'],
    "Ionocytes": ['SCGB1A1', 'RDH10', 'S100A6', 'KRT19', 'CLDN4'],
    "Airway epithelial cells": ['CSTA', 'S100A2', 'HSPB1', 'RPS18', 'KRT6A'],
    "Pulmonary alveolar type I cells": ['SCGB3A1', 'KRT14', 'KRT15', 'WFDC2', 'SCGB1A1'],
    "Proliferating epithelium cells": ['TUBA1B', 'STMN1', 'TOP2A', 'HMGB1', 'H2AFZ']
}

# DPI3 STACKED VIOLIN PLOT
import numpy as np
sc.pl.stacked_violin(dpi3_adata, marker_genes_dict_dpi3, cmap='RdBu_r', groupby="cell_type", show=False)
# Adjust title
plt.suptitle("Marker Gene Expression - Day 3", y=1.5, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# VISUALIZE GENE EXPRESSION IN ANNOTATED CELLS (ACE2, ENO2) - 4A PLOT

# Create a figure with subplots
fig, axes = plt.subplots(4, 2, figsize=(10, 18))
# Mock sample
sc.pl.umap(mock_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Mock_ACE2", ax=axes[0,0], show=False)
sc.pl.umap(mock_adata, color=["ENO2"], cmap='Oranges', vmax='p95', size=8, title="Mock_ENO2", ax=axes[0,1], show=False)
# Day_1 sample
sc.pl.umap(dpi1_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Day 1_ACE2", ax=axes[1,0], show=False)
sc.pl.umap(dpi1_adata, color=["ENO2"], cmap='Oranges', vmax='p95', size=8, title="Day 1_ENO2", ax=axes[1,1], show=False)
# Day_2 sample
sc.pl.umap(dpi2_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Day 2_ACE2", ax=axes[2,0], show=False)
sc.pl.umap(dpi2_adata, color=["ENO2"], cmap='Oranges', vmax='p95', size=8, title="Day 2_ENO2", ax=axes[2,1], show=False)
# Day_3 sample
sc.pl.umap(dpi3_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Day 3_ACE2", ax=axes[3,0], show=False)
sc.pl.umap(dpi3_adata, color=["ENO2"], cmap='Oranges', vmax='p95', size=8, title="Day 3_ENO2", ax=axes[3,1], show=False)
# Adjust title
plt.suptitle("ACE2 vs ENO2 Expression Across Timepoints", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# VISUALIZE GENE EXPRESSION IN ANNOTATED CELLS (ACE2)

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(10, 9))
# Mock sample
sc.pl.umap(mock_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Mock_ACE2", ax=axes[0,0], show=False)
# Day_1 sample
sc.pl.umap(dpi1_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Day 1_ACE2", ax=axes[0,1], show=False)
# Day_2 sample
sc.pl.umap(dpi2_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Day 2_ACE2", ax=axes[1,0], show=False)
# Day_3 sample
sc.pl.umap(dpi3_adata, color=["ACE2"], cmap='Oranges', vmax='p95', size=8, title="Day 3_ACE2", ax=axes[1,1], show=False)
# Adjust title
plt.suptitle("ACE2 Expression Across Timepoints", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# VISUALIZE GENE EXPRESSION IN ANNOTATED CELLS (ACE2, CTSL, TMPRSS2, TMPRSS4) - 4A PLOT
import matplotlib.pyplot as plt
# Create a figure with 4x4 subplots
fig, axes = plt.subplots(4, 4, figsize=(16, 12))
# Genes to plot
genes = ['ACE2', 'CTSL', 'TMPRSS2', 'TMPRSS4']
# Row 0: Mock
sc.pl.umap(mock_adata, color='ACE2', cmap='Oranges', vmax='p95', size=8, title='Mock_ACE2', ax=axes[0,0], show=False)
sc.pl.umap(mock_adata, color='CTSL', cmap='Oranges', vmax='p95', size=8, title='Mock_CTSL', ax=axes[0,1], show=False)
sc.pl.umap(mock_adata, color='TMPRSS2', cmap='Oranges', vmax='p95', size=8, title='Mock_TMPRSS2', ax=axes[0,2], show=False)
sc.pl.umap(mock_adata, color='TMPRSS4', cmap='Oranges', vmax='p95', size=8, title='Mock_TMPRSS4', ax=axes[0,3], show=False)
# Row 1: Day 1
sc.pl.umap(dpi1_adata, color='ACE2', cmap='Oranges', vmax='p95', size=8, title='Day1_ACE2', ax=axes[1,0], show=False)
sc.pl.umap(dpi1_adata, color='CTSL', cmap='Oranges', vmax='p95', size=8, title='Day1_CTSL', ax=axes[1,1], show=False)
sc.pl.umap(dpi1_adata, color='TMPRSS2', cmap='Oranges', vmax='p95', size=8, title='Day1_TMPRSS2', ax=axes[1,2], show=False)
sc.pl.umap(dpi1_adata, color='TMPRSS4', cmap='Oranges', vmax='p95', size=8, title='Day1_TMPRSS4', ax=axes[1,3], show=False)
# Row 2: Day 2
sc.pl.umap(dpi2_adata, color='ACE2', cmap='Oranges', vmax='p95', size=8, title='Day2_ACE2', ax=axes[2,0], show=False)
sc.pl.umap(dpi2_adata, color='CTSL', cmap='Oranges', vmax='p95', size=8, title='Day2_CTSL', ax=axes[2,1], show=False)
sc.pl.umap(dpi2_adata, color='TMPRSS2', cmap='Oranges', vmax='p95', size=8, title='Day2_TMPRSS2', ax=axes[2,2], show=False)
sc.pl.umap(dpi2_adata, color='TMPRSS4', cmap='Oranges', vmax='p95', size=8, title='Day2_TMPRSS4', ax=axes[2,3], show=False)
# Row 3: Day 3
sc.pl.umap(dpi3_adata, color='ACE2', cmap='Oranges', vmax='p95', size=8, title='Day3_ACE2', ax=axes[3,0], show=False)
sc.pl.umap(dpi3_adata, color='CTSL', cmap='Oranges', vmax='p95', size=8, title='Day3_CTSL', ax=axes[3,1], show=False)
sc.pl.umap(dpi3_adata, color='TMPRSS2', cmap='Oranges', vmax='p95', size=8, title='Day3_TMPRSS2', ax=axes[3,2], show=False)
sc.pl.umap(dpi3_adata, color='TMPRSS4', cmap='Oranges', vmax='p95', size=8, title='Day3_TMPRSS4', ax=axes[3,3], show=False)
# Adjust title
plt.suptitle("Viral Entry Gene Expression", y=1.0, fontsize=14, fontweight='bold')
plt.tight_layout()
plt.savefig('gene_expression_4x4.png', dpi=300, bbox_inches='tight')
plt.show()

# HEATMAP PLOT - FIGURE 4B

# 1. Concatenate
mock_adata.obs['condition'] = 'Mock'
dpi1_adata.obs['condition'] = 'Day_1'
dpi2_adata.obs['condition'] = 'Day_2'
dpi3_adata.obs['condition'] = 'Day_3'
combined_adata = ad.concat([mock_adata, dpi1_adata, dpi2_adata, dpi3_adata])
# 2. Make Figure 4B (ciliated cells only)
ciliated = combined_adata[combined_adata.obs['cell_type'] == 'Ciliated cells']
# 3. Create plot
sc.pl.heatmap(ciliated,
              ['ACE2', 'TMPRSS2', 'CTSL', 'TMPRSS4'],
              groupby='condition',
              cmap='Reds',
              swap_axes=True,
              figsize=(4, 5),
              dendrogram=False,
              show_gene_labels=True,
              show=False)
# 4. Get current figure and add title
fig = plt.gcf()
fig.suptitle('Ciliated Cells', fontsize=12, fontweight='bold', y=0.95)
plt.savefig('fig4B_ciliated.png', bbox_inches='tight', dpi=300)
plt.show()

# TRAJECTORY INFERENCE

# Graph drawing
sc.tl.draw_graph(mock_adata)
sc.tl.draw_graph(dpi1_adata)
sc.tl.draw_graph(dpi2_adata)
sc.tl.draw_graph(dpi3_adata)

# Graph plots

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(12, 10))

# Plot visualization
# Mock
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(mock_adata, color='cell_type', legend_loc='on data', size = 12, title = "Mock", legend_fontsize=8, ax=axes[0,0], show=False)
# Day_1
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(dpi1_adata, color='cell_type', legend_loc='on data', size = 12, title = "Day 1", legend_fontsize=8, ax=axes[0,1], show=False)
# Day_2
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(dpi2_adata, color='cell_type', legend_loc='on data', size = 12, title = "Day 2", legend_fontsize=8, ax=axes[1,0], show=False)
# Day_3
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(dpi3_adata, color='cell_type', legend_loc='on data', size = 12, title = "Day3", legend_fontsize=8, ax=axes[1,1], show=False)

plt.tight_layout()
plt.show()

# Graph plots

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(16, 10))

# Plot visualization
# Mock
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(mock_adata, color='cell_type', size = 12, legend_fontsize=8, title = "Mock", ax=axes[0,0], show=False)
# Day_1
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(dpi1_adata, color='cell_type', size = 12, legend_fontsize=8, title = "Day 1", ax=axes[0,1], show=False)
# Day_2
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(dpi2_adata, color='cell_type', size = 12, legend_fontsize=8, title = "Day 2", ax=axes[1,0], show=False)
# Day_3
plt.rcParams["figure.figsize"] = (8,8)
sc.pl.draw_graph(dpi3_adata, color='cell_type', size = 12, legend_fontsize=8, title = "Day 3", ax=axes[1,1], show=False)

plt.tight_layout()
plt.show()

# Abstract the graph
sc.tl.paga(mock_adata, groups='cell_type')
sc.tl.paga(dpi1_adata, groups='cell_type')
sc.tl.paga(dpi2_adata, groups='cell_type')
sc.tl.paga(dpi3_adata, groups='cell_type')

# Plot the PAGA graphs

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(18, 8))

# Plot visualization
# Mock
sc.pl.paga(mock_adata, color=['cell_type'], fontsize=8, node_size_scale=3, title = "Mock", ax=axes[0,0], show=False)
# Day_1
sc.pl.paga(dpi1_adata, color=['cell_type'], fontsize=8, node_size_scale=3, title = "Day 1", ax=axes[0,1], show=False)
# Day_2
sc.pl.paga(dpi2_adata, color=['cell_type'], fontsize=8, node_size_scale=3, title = "Day 2", ax=axes[1,0], show=False)
# Day_3
sc.pl.paga(dpi3_adata, color=['cell_type'], fontsize=8, node_size_scale=3, title = "Day 3", ax=axes[1,1], show=False)

# Adjust title
plt.suptitle("PAGA graph", y=1.0, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Plot the PAGA graphs
# Mock
plt.rcParams["figure.figsize"] = (10, 8)
sc.pl.paga(mock_adata, color='cell_type', fontsize=8, node_size_scale=5, title="PAGA - Mock")

# Plot the PAGA graphs
# Day_1
plt.rcParams["figure.figsize"] = (10, 8)
sc.pl.paga(dpi1_adata, color='cell_type', fontsize=8, node_size_scale=5, title="PAGA - Day 1")

# Plot the PAGA graphs
# Day_2
plt.rcParams["figure.figsize"] = (10, 8)
sc.pl.paga(dpi2_adata, color='cell_type', fontsize=8, node_size_scale=5, title="PAGA - Day 2")

# Plot the PAGA graphs
# Day_3
plt.rcParams["figure.figsize"] = (10, 8)
sc.pl.paga(dpi3_adata, color='cell_type', fontsize=8, node_size_scale=5, title="PAGA - Day 3")

# Initialize graph layout using PAGA structure as starting point
sc.tl.draw_graph(mock_adata, init_pos='paga')
sc.tl.draw_graph(dpi1_adata, init_pos='paga')
sc.tl.draw_graph(dpi2_adata, init_pos='paga')
sc.tl.draw_graph(dpi3_adata, init_pos='paga')

# Visualization

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(16, 10))

sc.pl.draw_graph(mock_adata, color='cell_type', ax=axes[0,0], show=False)
sc.pl.draw_graph(dpi1_adata, color='cell_type', ax=axes[0,1], show=False)
sc.pl.draw_graph(dpi2_adata, color='cell_type', ax=axes[1,0], show=False)
sc.pl.draw_graph(dpi3_adata, color='cell_type', ax=axes[1,1], show=False)

# Adjust title
plt.suptitle("draw_graph", y=1.0, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Visualization

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(16, 10))

sc.pl.draw_graph(mock_adata, color='cell_type', legend_fontsize = 7, legend_loc='on data', size=12, ax=axes[0,0], show=False)
sc.pl.draw_graph(dpi1_adata, color='cell_type', legend_fontsize = 7, legend_loc='on data', size=12, ax=axes[0,1], show=False)
sc.pl.draw_graph(dpi2_adata, color='cell_type', legend_fontsize = 7, legend_loc='on data', size=12, ax=axes[1,0], show=False)
sc.pl.draw_graph(dpi3_adata, color='cell_type', legend_fontsize = 7, legend_loc='on data', size=12, ax=axes[1,1], show=False)

# Adjust title
plt.suptitle("draw_graph", y=1.0, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# PAGA/UMAP comparison - Mock
plt.rcParams["figure.figsize"] = (7,5)
sc.pl.paga_compare(mock_adata, threshold=0.03, frameon=True, edges=True, title = "PAGA/UMAP comparison - Mock", node_size_scale=5, fontsize=6, size = 12, legend_fontsize = 7)

# PAGA/UMAP comparison - Day 1
plt.rcParams["figure.figsize"] = (7,5)
sc.pl.paga_compare(dpi1_adata, threshold=0.03, frameon=True, edges=True, title = "PAGA/UMAP comparison - Day 1", node_size_scale=5, fontsize=6, size = 12, legend_fontsize = 7)

# PAGA/UMAP comparison - Day 2
plt.rcParams["figure.figsize"] = (7,5)
sc.pl.paga_compare(dpi2_adata, threshold=0.03, frameon=True, edges=True, title = "PAGA/UMAP comparison - Day 2", node_size_scale=5, fontsize=6, size = 12, legend_fontsize = 7)

plt.rcParams["figure.figsize"] = (7,5)
sc.pl.paga_compare(dpi3_adata, threshold=0.03, frameon=True, edges=True, title = "PAGA/UMAP comparison - Day 3", node_size_scale=5, size = 12, fontsize=6, legend_fontsize = 7)

import numpy as np
mock_adata.uns['iroot'] = np.flatnonzero(mock_adata.obs['leiden_res0_5'] == '0')[0]
sc.tl.dpt(mock_adata)
dpi1_adata.uns['iroot'] = np.flatnonzero(dpi1_adata.obs['leiden_res0_5'] == '0')[0]
sc.tl.dpt(dpi1_adata)
dpi2_adata.uns['iroot'] = np.flatnonzero(dpi2_adata.obs['leiden_res0_5'] == '0')[0]
sc.tl.dpt(dpi2_adata)
dpi3_adata.uns['iroot'] = np.flatnonzero(dpi3_adata.obs['leiden_res0_5'] == '0')[0]
sc.tl.dpt(dpi3_adata)

# Pseudotime on UMAP/fraw_graph - Mock
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(mock_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_fontsize = 14, size = 12, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Mock", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Mock
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(mock_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_loc='on data', legend_fontsize = 8, size = 14, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Mock", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Day 1
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(dpi1_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_fontsize = 14, size = 12, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Day 1", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Day 1
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(dpi1_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_loc='on data', legend_fontsize = 8, size = 14, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Day 1", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Day 2
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(dpi2_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_fontsize = 14, size = 12, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Day 2", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Day 2
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(dpi2_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_loc='on data', legend_fontsize = 8, size = 14, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Day 2", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Day 3
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(dpi3_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_fontsize = 14, size = 12, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Day 3", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Pseudotime on UMAP/fraw_graph - Day 3
plt.rcParams["figure.figsize"] = (10,8)
sc.pl.draw_graph(dpi3_adata, color=['dpt_pseudotime', 'cell_type'], title = "dpt_pseudotime", legend_loc='on data', legend_fontsize = 8, size = 14, show=False)
# Adjust title
plt.suptitle("Pseudotime on UMAP/draw_graph - Day 3", y=0.98, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Visualization Pseudotimes All

# Create a figure with 2x2 subplots
fig, axes = plt.subplots(2, 2, figsize=(16, 10))

sc.pl.draw_graph(mock_adata, color=['dpt_pseudotime'], ax=axes[0,0], show=False)
sc.pl.draw_graph(dpi1_adata, color=['dpt_pseudotime'], ax=axes[0,1], show=False)
sc.pl.draw_graph(dpi2_adata, color=['dpt_pseudotime'], ax=axes[1,0], show=False)
sc.pl.draw_graph(dpi3_adata, color=['dpt_pseudotime'], ax=axes[1,1], show=False)

# Adjust title
plt.suptitle("Pseudotime - All Timepoints", y=1.0, fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Mock
fig, axes = plt.subplots(1, 3, figsize=(18, 6))

# Row 1: Viral entry
sc.pl.draw_graph(mock_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0], show=False, title='Pseudotime')
sc.pl.draw_graph(mock_adata, color='ACE2', cmap='viridis', ax=axes[1], show=False, title='ACE2')
sc.pl.draw_graph(mock_adata, color='ENO2', cmap='viridis', ax=axes[2], show=False, title='ENO2')

plt.suptitle('Gene expression along pseudotime - Mock', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Mock
fig, axes = plt.subplots(2, 3, figsize=(18, 12))

# Row 1: Viral entry
sc.pl.draw_graph(mock_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0,0], show=False, title='Pseudotime')
sc.pl.draw_graph(mock_adata, color='ACE2', cmap='viridis', ax=axes[0,1], show=False, title='ACE2')
sc.pl.draw_graph(mock_adata, color='ENO2', cmap='viridis', ax=axes[0,2], show=False, title='ENO2')

# Row 2: Other key genes
sc.pl.draw_graph(mock_adata, color='CTSL', cmap='viridis', ax=axes[1,0], show=False, title='CTSL')
sc.pl.draw_graph(mock_adata, color='TMPRSS2', cmap='viridis', ax=axes[1,1], show=False, title='TMPRSS2')
sc.pl.draw_graph(mock_adata, color='TMPRSS4', cmap='viridis', ax=axes[1,2], show=False, title='TMPRSS4')

plt.suptitle('Gene expression along pseudotime - Mock', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 1
fig, axes = plt.subplots(1, 3, figsize=(18, 6))

# Row 1: Viral entry
sc.pl.draw_graph(dpi1_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0], show=False, title='Pseudotime')
sc.pl.draw_graph(dpi1_adata, color='ACE2', cmap='viridis', ax=axes[1], show=False, title='ACE2')
sc.pl.draw_graph(dpi1_adata, color='ENO2', cmap='viridis', ax=axes[2], show=False, title='ENO2')

plt.suptitle('Gene expression along pseudotime - Day 1', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 1
fig, axes = plt.subplots(2, 3, figsize=(18, 12))

# Row 1: Viral entry
sc.pl.draw_graph(dpi1_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0,0], show=False, title='Pseudotime')
sc.pl.draw_graph(dpi1_adata, color='ACE2', cmap='viridis', ax=axes[0,1], show=False, title='ACE2')
sc.pl.draw_graph(dpi1_adata, color='ENO2', cmap='viridis', ax=axes[0,2], show=False, title='ENO2')

# Row 2: Other key genes
sc.pl.draw_graph(dpi1_adata, color='CTSL', cmap='viridis', ax=axes[1,0], show=False, title='CTSL')
sc.pl.draw_graph(dpi1_adata, color='TMPRSS2', cmap='viridis', ax=axes[1,1], show=False, title='TMPRSS2')
sc.pl.draw_graph(dpi1_adata, color='TMPRSS4', cmap='viridis', ax=axes[1,2], show=False, title='TMPRSS4')

plt.suptitle('Gene expression along pseudotime - Day 1', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 2
fig, axes = plt.subplots(1, 3, figsize=(18, 6))

# Row 1: Viral entry
sc.pl.draw_graph(dpi2_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0], show=False, title='Pseudotime')
sc.pl.draw_graph(dpi2_adata, color='ACE2', cmap='viridis', ax=axes[1], show=False, title='ACE2')
sc.pl.draw_graph(dpi2_adata, color='ENO2', cmap='viridis', ax=axes[2], show=False, title='ENO2')

plt.suptitle('Gene expression along pseudotime - Day 2', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 2
fig, axes = plt.subplots(2, 3, figsize=(18, 12))

# Row 1: Viral entry
sc.pl.draw_graph(dpi2_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0,0], show=False, title='Pseudotime')
sc.pl.draw_graph(dpi2_adata, color='ACE2', cmap='viridis', ax=axes[0,1], show=False, title='ACE2')
sc.pl.draw_graph(dpi2_adata, color='ENO2', cmap='viridis', ax=axes[0,2], show=False, title='ENO2')

# Row 2: Other key genes
sc.pl.draw_graph(dpi2_adata, color='CTSL', cmap='viridis', ax=axes[1,0], show=False, title='CTSL')
sc.pl.draw_graph(dpi2_adata, color='TMPRSS2', cmap='viridis', ax=axes[1,1], show=False, title='TMPRSS2')
sc.pl.draw_graph(dpi2_adata, color='TMPRSS4', cmap='viridis', ax=axes[1,2], show=False, title='TMPRSS4')

plt.suptitle('Gene expression along pseudotime - Day 2', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 3
fig, axes = plt.subplots(1, 3, figsize=(18, 6))

# Row 1: Viral entry
sc.pl.draw_graph(dpi3_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0], show=False, title='Pseudotime')
sc.pl.draw_graph(dpi3_adata, color='ACE2', cmap='viridis', ax=axes[1], show=False, title='ACE2')
sc.pl.draw_graph(dpi3_adata, color='ENO2', cmap='viridis', ax=axes[2], show=False, title='ENO2')

plt.suptitle('Gene expression along pseudotime - Day 3', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 3
fig, axes = plt.subplots(2, 3, figsize=(18, 12))

# Row 1: Viral entry
sc.pl.draw_graph(dpi3_adata, color='dpt_pseudotime', cmap='viridis', ax=axes[0,0], show=False, title='Pseudotime')
sc.pl.draw_graph(dpi3_adata, color='ACE2', cmap='viridis', ax=axes[0,1], show=False, title='ACE2')
sc.pl.draw_graph(dpi3_adata, color='ENO2', cmap='viridis', ax=axes[0,2], show=False, title='ENO2')

# Row 2: Other key genes
sc.pl.draw_graph(dpi3_adata, color='CTSL', cmap='viridis', ax=axes[1,0], show=False, title='CTSL')
sc.pl.draw_graph(dpi3_adata, color='TMPRSS2', cmap='viridis', ax=axes[1,1], show=False, title='TMPRSS2')
sc.pl.draw_graph(dpi3_adata, color='TMPRSS4', cmap='viridis', ax=axes[1,2], show=False, title='TMPRSS4')

plt.suptitle('Gene expression along pseudotime - Day 3', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 3
plt.rcParams["figure.figsize"] = (5,5)
sc.pl.draw_graph(dpi3_adata, color=['ACE2'], cmap='viridis', show=False, title='Pseudotime Gene Expression ACE2 - Day 3')


plt.tight_layout()
plt.show()

# Gene expression along pseudotime - Day 3
fig, axes = plt.subplots(2, 2, figsize=(10, 8))

sc.pl.draw_graph(mock_adata, color='ACE2', cmap='viridis', ax=axes[0,0], show=False, title='ACE2_Mock')
sc.pl.draw_graph(dpi1_adata, color='ACE2', cmap='viridis', ax=axes[0,1], show=False, title='ACE2_Day 1')
sc.pl.draw_graph(dpi2_adata, color='ACE2', cmap='viridis', ax=axes[1,0], show=False, title='ACE2_Day 2')
sc.pl.draw_graph(dpi3_adata, color='ACE2', cmap='viridis', ax=axes[1,1], show=False, title='ACE2_Day 3')

plt.suptitle('Gene expression along pseudotime - ACE2', fontsize=16, y=0.995)
plt.tight_layout()
plt.show()
